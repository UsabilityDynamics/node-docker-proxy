machine:
  node:
    version: v0.11.13
  services:
    - docker

dependencies:
  override:
    - docker pull andypotanin/express:latest
    - NODE_ENV=development npm install

test:
  override:
    - sudo chown ubuntu /etc/hosts
    - echo "127.0.0.1 site1.com" >> /etc/hosts
    - echo "127.0.0.1 api.site1.com" >> /etc/hosts
    - echo "127.0.0.1 cdn.site1.com" >> /etc/hosts
    - echo "127.0.0.1 www.site1.com" >> /etc/hosts
    - echo "127.0.0.1 site2.com" >> /etc/hosts
    - echo "127.0.0.1 api.site2.com" >> /etc/hosts
    - echo "127.0.0.1 cdn.site2.com" >> /etc/hosts
    - echo "127.0.0.1 www.site2.com" >> /etc/hosts
    - echo "127.0.0.1 site3.com" >> /etc/hosts
    - echo "127.0.0.1 api.site3.com" >> /etc/hosts
    - echo "127.0.0.1 cdn.site3.com" >> /etc/hosts
    - echo "127.0.0.1 www.site3.com" >> /etc/hosts
    - sudo chown root /etc/hosts
    - git config --global user.email "andy@udx.io"
    - git config --global user.name "andypotanin"
    - git config --global push.default simple
    - mocha test/unit
    - mocha test/functional
    - mocha test/integration
    - make image; sleep 5
    - make run; sleep 5
    - mocha test/acceptance

deployment:
  hub:
    branch: master
    commands:
      - docker login --username=${DOCKER_HUB_USERNAME} --email=${DOCKER_HUB_EMAIL} --password=${DOCKER_HUB_PASSWORD}
      - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < .dockercfg.template > ~/.dockercfg
      - docker push usabilitydynamics/docker-proxy:latest
