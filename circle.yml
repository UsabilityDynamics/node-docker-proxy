machine:
  node:
    version: v0.11.13
  services:
    - docker
  hosts:
    site1.com: 127.0.0.1
    api.site1.com: 127.0.0.1
    cdn.site1.com: 127.0.0.1
    www.site1.com: 127.0.0.1
    site2.com: 127.0.0.1
    api.site2.com: 127.0.0.1
    cdn.site2.com: 127.0.0.1
    www.site2.com: 127.0.0.1
    site3.com: 127.0.0.1
    api.site3.com: 127.0.0.1
    cdn.site3.com: 127.0.0.1
    www.site3.com: 127.0.0.1

dependencies:
  pre:
    - "export DOCKER_ADDRESS=$(ifconfig docker0 | grep 'inet addr' | awk -F: '{print $2}' | awk '{print $1}')"
    - echo "DOCKER_OPTS='--host=tcp://${DOCKER_ADDRESS}:2380 --host=unix:///var/run/docker.sock -s btrfs -e lxc'" | sudo tee --append /etc/default/docker > /dev/null
    - sudo service docker restart
    - docker login --username=${DOCKER_HUB_USERNAME} --email=${DOCKER_HUB_EMAIL} --password=${DOCKER_HUB_PASSWORD}
    - docker pull andypotanin/express:latest
    - NODE_ENV=development npm link

test:
  pre:
    - git config --global user.email ${GITHUB_EMAIL}
    - git config --global user.name ${GITHUB_USERNAME}
    - git config --global push.default simple
    - sh /home/ubuntu/node-docker-proxy/test/acceptance/fixtures/start-containers.sh

  override:
    - mocha test/unit
    - mocha test/functional
    - mocha test/integration
    - make image; sleep 5
    - make run; sleep 5
    - mocha test/acceptance